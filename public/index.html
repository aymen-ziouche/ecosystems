<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full XRP Ecosystem Developer Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #1a1a1a; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { width: 90%; max-width: 1200px; background-color: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 30px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        h1, h2 { color: #ffffff; text-align: center; }
        .chart-wrapper { position: relative; height: 500px; width: 100%; }
        #ecosystem-breakdown { padding-top: 10px; }
        .ecosystem-row { margin-bottom: 16px; }
        .ecosystem-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; font-weight: 500; }
        .ecosystem-label span:first-child { color: #ffffff; }
        .ecosystem-label span:last-child { color: #a0a0a0; }
        .progress-bar-container { height: 10px; width: 100%; background-color: rgba(255, 255, 255, 0.1); border-radius: 5px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-in-out; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: white; display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.5em; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">
        <p>Loading remote commit data...</p>
    </div>

    <h1>Full XRP Ecosystem Developer Report</h1>

    <div class="container">
        <h2>Monthly Commits by Developer Type</h2>
        <div class="chart-wrapper">
            <canvas id="commitReportChart"></canvas>
        </div>
    </div>
    
    <div class="container">
        <h2>Monthly Developers by Type</h2>
        <div class="chart-wrapper">
            <canvas id="developerReportChart"></canvas>
        </div>
    </div>

    <div class="container">
        <h2>Monthly Commits by Ecosystem</h2>
        <div class="chart-wrapper">
            <canvas id="commitTrendChart"></canvas>
        </div>
    </div>

    <div id="ecosystem-breakdown" class="container">
        </div>

    <script>
        // --- DATA SECTION ---
        const commitVolumeData = {
          "2023-02": {"full_time_commits": 0, "part_time_commits": 0, "one_time_commits": 1}, "2023-05": {"full_time_commits": 0, "part_time_commits": 0, "one_time_commits": 1}, "2023-08": {"full_time_commits": 0, "part_time_commits": 24, "one_time_commits": 0}, "2023-09": {"full_time_commits": 0, "part_time_commits": 4, "one_time_commits": 0}, "2024-01": {"full_time_commits": 0, "part_time_commits": 7, "one_time_commits": 0}, "2024-02": {"full_time_commits": 0, "part_time_commits": 1, "one_time_commits": 0}, "2024-03": {"full_time_commits": 0, "part_time_commits": 0, "one_time_commits": 3}, "2024-06": {"full_time_commits": 0, "part_time_commits": 30, "one_time_commits": 1}, "2024-07": {"full_time_commits": 0, "part_time_commits": 6, "one_time_commits": 1}, "2024-08": {"full_time_commits": 0, "part_time_commits": 7, "one_time_commits": 3}, "2024-09": {"full_time_commits": 210, "part_time_commits": 472, "one_time_commits": 163}, "2024-10": {"full_time_commits": 558, "part_time_commits": 657, "one_time_commits": 175}, "2024-11": {"full_time_commits": 475, "part_time_commits": 687, "one_time_commits": 176}, "2024-12": {"full_time_commits": 585, "part_time_commits": 701, "one_time_commits": 128}, "2025-01": {"full_time_commits": 736, "part_time_commits": 777, "one_time_commits": 137}, "2025-02": {"full_time_commits": 707, "part_time_commits": 699, "one_time_commits": 127}, "2025-03": {"full_time_commits": 494, "part_time_commits": 655, "one_time_commits": 158}, "2025-04": {"full_time_commits": 1233, "part_time_commits": 585, "one_time_commits": 180}, "2025-05": {"full_time_commits": 1618, "part_time_commits": 713, "one_time_commits": 157}, "2025-06": {"full_time_commits": 755, "part_time_commits": 866, "one_time_commits": 218}, "2025-07": {"full_time_commits": 916, "part_time_commits": 1035, "one_time_commits": 55}, "2025-08": {"full_time_commits": 404, "part_time_commits": 1401, "one_time_commits": 40}, "2025-09": {"full_time_commits": 30, "part_time_commits": 371, "one_time_commits": 27}
        };
        const devCountData = {
          "2023-02": {"full_time": 0, "part_time": 0, "one_time": 1}, "2023-05": {"full_time": 0, "part_time": 0, "one_time": 1}, "2023-08": {"full_time": 0, "part_time": 1, "one_time": 0}, "2023-09": {"full_time": 0, "part_time": 1, "one_time": 0}, "2024-01": {"full_time": 0, "part_time": 1, "one_time": 0}, "2024-02": {"full_time": 0, "part_time": 1, "one_time": 0}, "2024-03": {"full_time": 0, "part_time": 0, "one_time": 1}, "2024-06": {"full_time": 0, "part_time": 1, "one_time": 1}, "2024-07": {"full_time": 0, "part_time": 1, "one_time": 1}, "2024-08": {"full_time": 0, "part_time": 2, "one_time": 3}, "2024-09": {"full_time": 4, "part_time": 56, "one_time": 106}, "2024-10": {"full_time": 13, "part_time": 112, "one_time": 154}, "2024-11": {"full_time": 12, "part_time": 148, "one_time": 160}, "2024-12": {"full_time": 14, "part_time": 174, "one_time": 111}, "2025-01": {"full_time": 16, "part_time": 161, "one_time": 122}, "2025-02": {"full_time": 15, "part_time": 171, "one_time": 114}, "2025-03": {"full_time": 11, "part_time": 170, "one_time": 142}, "2025-04": {"full_time": 15, "part_time": 156, "one_time": 138}, "2025-05": {"full_time": 16, "part_time": 168, "one_time": 118}, "2025-06": {"full_time": 18, "part_time": 170, "one_time": 121}, "2025-07": {"full_time": 16, "part_time": 96, "one_time": 26}, "2025-08": {"full_time": 11, "part_time": 78, "one_time": 17}, "2025-09": {"full_time": 1, "part_time": 53, "one_time": 11}
        };

        // --- CHART RENDERING LOGIC ---

        function renderCommitVolumeChart(data) {
             const labels = Object.keys(data).sort();
             
             // --- THIS LOGIC WAS MISSING ---
             const fullTimeData = labels.map(m => data[m].full_time_commits);
             const partTimeData = labels.map(m => data[m].part_time_commits);
             const oneTimeData = labels.map(m => data[m].one_time_commits);
             const totalData = labels.map((m, i) => fullTimeData[i] + partTimeData[i] + oneTimeData[i]);

             const datasets = [
                // --- THIS DATASET WAS MISSING ---
                { label: 'Total Commits', data: totalData, borderColor: '#36A2EB', backgroundColor: 'transparent', borderWidth: 3, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 },
                { label: 'Commits by full-time devs', data: fullTimeData, borderColor: '#E0E0E0', backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 },
                { label: 'Commits by part-time devs', data: partTimeData, borderColor: '#FFD700', backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 },
                { label: 'Commits by one-time devs', data: oneTimeData, borderColor: '#808080', backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 }
             ];
             const ctx = document.getElementById('commitReportChart').getContext('2d');
             new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    maintainAspectRatio: false, responsive: true, interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Commits', color: '#e0e0e0', font: { size: 14 } }, grid: { color: 'rgba(255, 255, 255, 0.1)', drawBorder: false }, ticks: { color: '#e0e0e0', precision: 0 }},
                        x: { grid: { display: false }, ticks: { color: '#e0e0e0', autoSkip: true, maxTicksLimit: 12 }}
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#e0e0e0', boxWidth: 15, padding: 25, font: { size: 14 } } },
                        tooltip: { mode: 'index', intersect: false, titleFont: { weight: 'bold' }, bodyFont: { size: 13 }, padding: 10 },
                    }
                }
             });
        }

        function renderDeveloperCountChart(data) {
            const labels = Object.keys(data).sort();
            
            // --- THIS LOGIC WAS MISSING ---
            const fullTimeData = labels.map(m => data[m].full_time);
            const partTimeData = labels.map(m => data[m].part_time);
            const oneTimeData = labels.map(m => data[m].one_time);
            const totalData = labels.map((m, i) => fullTimeData[i] + partTimeData[i] + oneTimeData[i]);

            const datasets = [
                // --- THIS DATASET WAS MISSING ---
                { label: 'Total Developers', data: totalData, borderColor: '#36A2EB', backgroundColor: 'transparent', borderWidth: 3, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 },
                { label: 'Full-time devs', data: fullTimeData, borderColor: '#E0E0E0', backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 },
                { label: 'Part-time devs', data: partTimeData, borderColor: '#FFD700', backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 },
                { label: 'One-time devs', data: oneTimeData, borderColor: '#808080', backgroundColor: 'transparent', borderWidth: 2.5, tension: 0.4, pointRadius: 1, pointHoverRadius: 6 }
            ];
            const ctx = document.getElementById('developerReportChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    maintainAspectRatio: false, responsive: true, interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Developers', color: '#e0e0e0', font: { size: 14 } }, grid: { color: 'rgba(255, 255, 255, 0.1)', drawBorder: false }, ticks: { color: '#e0e0e0', precision: 0 }},
                        x: { grid: { display: false }, ticks: { color: '#e0e0e0', autoSkip: true, maxTicksLimit: 12 }}
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#e0e0e0', boxWidth: 15, padding: 25, font: { size: 14 } } },
                        tooltip: { mode: 'index', intersect: false, titleFont: { weight: 'bold' }, bodyFont: { size: 13 }, padding: 10 },
                    }
                }
            });
        }

        function renderEcosystemCharts(jsonData) {
            const getDistinctColors = (numColors) => {
                const colors = [];
                for (let i = 0; i < numColors; i++) {
                    const hue = i * (360 / numColors);
                    colors.push(`hsl(${hue}, 70%, 60%)`);
                }
                return colors;
            };

            const commitsByEcosystemAndDay = {};
            const allDates = new Set();
            jsonData.forEach((repoData) => {
                const ecosystem = repoData.ecosystem;
                repoData.commits.forEach((commit) => {
                    if (commit.date) {
                        const date = new Date(commit.date).toISOString().split('T')[0];
                        allDates.add(date);
                        if (!commitsByEcosystemAndDay[ecosystem]) commitsByEcosystemAndDay[ecosystem] = {};
                        if (!commitsByEcosystemAndDay[ecosystem][date]) commitsByEcosystemAndDay[ecosystem][date] = 0;
                        commitsByEcosystemAndDay[ecosystem][date]++;
                    }
                });
            });

            const sortedUniqueDates = Array.from(allDates).sort();
            const ecosystemNames = Object.keys(commitsByEcosystemAndDay);
            const ecosystemColors = getDistinctColors(ecosystemNames.length);
            const colorMap = {};
            ecosystemNames.forEach((name, index) => {
                colorMap[name] = ecosystemColors[index];
            });

            const datasets = ecosystemNames.map((ecosystem) => {
                const data = sortedUniqueDates.map((date) => commitsByEcosystemAndDay[ecosystem][date] || 0);
                const color = colorMap[ecosystem];
                return {
                    label: ecosystem, data: data, borderColor: color,
                    backgroundColor: color.replace('hsl', 'hsla').replace(')', ', 0.2)'),
                    borderWidth: 1.5, fill: true, tension: 0.4, pointRadius: 0, hoverRadius: 5,
                };
            });

            const trendCtx = document.getElementById('commitTrendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: { labels: sortedUniqueDates, datasets: datasets },
                options: {
                    maintainAspectRatio: false, responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Commits', color: '#e0e0e0' }, grid: { color: 'rgba(255, 255, 255, 0.1)', drawBorder: false }, ticks: { color: '#e0e0e0', precision: 0 } },
                        x: { stacked: true, grid: { display: false, drawBorder: false }, ticks: { color: '#e0e0e0', autoSkip: true, maxTicksLimit: 10 } },
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#e0e0e0', boxWidth: 12, padding: 20 } },
                        tooltip: { mode: 'index', intersect: false },
                    },
                },
            });

            const commitsByEcosystemTotal = {};
            let totalAllCommits = 0;
            jsonData.forEach((repoData) => {
                const ecosystem = repoData.ecosystem;
                const commitCount = repoData.commits.length;
                if (!commitsByEcosystemTotal[ecosystem]) commitsByEcosystemTotal[ecosystem] = 0;
                commitsByEcosystemTotal[ecosystem] += commitCount;
                totalAllCommits += commitCount;
            });
            const sortedEcosystemsForBreakdown = Object.entries(commitsByEcosystemTotal).sort(([, a], [, b]) => b - a);
            const breakdownContainer = document.getElementById('ecosystem-breakdown');
            let breakdownHtml = '<h2>Commit Distribution by Ecosystem</h2>';
            sortedEcosystemsForBreakdown.forEach(([ecosystem, count]) => {
                const percentage = totalAllCommits > 0 ? (count / totalAllCommits) * 100 : 0;
                if (count > 0) {
                    breakdownHtml += `
                        <div class="ecosystem-row">
                            <div class="ecosystem-label">
                                <span>${ecosystem}</span>
                                <span>${percentage.toFixed(2)}% (${count.toLocaleString()} commits)</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${percentage}%; background-color: ${colorMap[ecosystem] || '#8465FF'};"></div>
                            </div>
                        </div>
                    `;
                }
            });
            breakdownContainer.innerHTML = breakdownHtml;
        }

        // --- MAIN ORCHESTRATOR ---
        async function renderAllCharts() {
            // Render the charts with local data immediately
            renderCommitVolumeChart(commitVolumeData);
            renderDeveloperCountChart(devCountData);
            
            try {
                // Fetch the remote data for the third chart
                const dataUrl = 'https://mrfofellyffayhzroxrz.supabase.co/storage/v1/object/sign/easy/xrp_data%20(2).json?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV9lYmQ2ZTI1NC1lMDc5LTQ2NTItOWRmMC0wMmRiMGM4MWEwZWQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJlYXN5L3hycF9kYXRhICgyKS5qc29uIiwiaWF0IjoxNzU3OTM2OTI3LCJleHAiOjE3ODk0NzI5Mjd9.oeYx_R4QK7DLh4iayai2Co_W56ktNjfE49iTiQ59LSQ';
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}.`);
                const jsonData = await response.json();
                
                // Render the charts that depend on the fetched data
                renderEcosystemCharts(jsonData);

            } catch (error) {
                console.error("Failed to load or render remote data charts:", error);
                document.getElementById('loading').innerHTML = `<p style="color: red;">Failed to load remote data. Check console for details.</p>`;
            } finally {
                // Hide loading overlay once everything is done or has failed
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Run the main function
        renderAllCharts();
    </script>
</body>
</html>
